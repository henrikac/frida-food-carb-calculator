<!DOCTYPE html>
<html lang="da" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frida Food Carb Calculator</title>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full flex flex-col items-center justify-start p-6 font-sans">

  <h1 class="text-3xl font-bold mb-6 text-gray-800">Frida Food Carb Calculator</h1>

  <div class="w-full max-w-3xl bg-white rounded-lg shadow p-6 space-y-6">
    <!-- Upload fil -->
    <div>
      <label class="block mb-2 font-semibold text-gray-700" for="fileInput">Upload XLSX-fil</label>
      <input
        id="fileInput"
        type="file"
        accept=".xlsx,.xls"
        class="block w-full rounded border border-gray-300 px-3 py-2 text-gray-700
               focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
      />
    </div>

    <!-- Spinner -->
    <div id="spinner" class="hidden flex justify-center">
      <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10"
                stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
      </svg>
    </div>

    <div id="controls" class="hidden space-x-2">
      <!-- Ingrediens input -->
      <form id="inputForm" class="space-y-4" autocomplete="off">
        <input
          id="navnInput"
          type="text"
          list="navneList"
          placeholder="Vælg ingrediens..."
          class="block w-full rounded border border-gray-300 px-3 py-2 text-gray-700
                focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          required
        />
        <datalist id="navneList"></datalist>

        <input
          id="gramInput"
          type="number"
          min="0"
          step="any"
          placeholder="Indtast vægt i gram"
          class="block w-full rounded border border-gray-300 px-3 py-2 text-gray-700
                focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          required
        />

        <button
          type="submit"
          class="w-full bg-indigo-600 text-white font-semibold rounded py-2 hover:bg-indigo-700 transition"
        >
          Tilføj ingrediens
        </button>
      </form>
    </div>

    <!-- Ingrediens tabel -->
    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border">Ingrediens</th>
            <th class="p-2 border">Gram</th>
            <th class="p-2 border">Kulhydrat / 100g</th>
            <th class="p-2 border">Total kulhydrat</th>
            <th class="p-2 border">Handlinger</th>
          </tr>
        </thead>
        <tbody id="ingredientsTable"></tbody>
        <tfoot class="bg-gray-50 font-bold">
          <tr>
            <td colspan="3" class="p-2 border text-right">Total:</td>
            <td id="totalCell" class="p-2 border">0.00</td>
            <td class="border"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Clear All Button -->
    <div class="flex justify-end">
      <button id="clearAllBtn" 
        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed"
        disabled
      >
        Ryd alle
      </button>
    </div>
  </div>

  <script>
    // ====== State ======
    let database = {};                 // { lowercasedName: carbsPer100 }
    let nameMap = {};                  // { lowercasedName: originalName }
    let entries = [];                  // [{ name, grams, kulPer100, totalKul }]

    // ====== DOM ======
    const fileInput   = document.getElementById("fileInput");
    const datalist    = document.getElementById("navneList");
    const navnInput   = document.getElementById("navnInput");
    const gramInput   = document.getElementById("gramInput");
    const spinner     = document.getElementById("spinner");
    const form        = document.getElementById("inputForm");
    const tableBody   = document.getElementById("ingredientsTable");
    const totalCell   = document.getElementById("totalCell");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const controls    = document.getElementById("controls");

    // ====== Utils ======
    function showSpinner(show) {
      spinner.classList.toggle("hidden", !show);
    }

    function findColumnIndex(row, searchTerm) {
      const needle = (searchTerm || "").toLowerCase().replace(/[^a-zæøå0-9]/g, "");
      for (let i = 0; i < row.length; i++) {
        if (!row[i]) continue;
        const clean = row[i].toString().toLowerCase().replace(/[^a-zæøå0-9]/g, "");
        if (clean.includes(needle)) return i;
      }
      return -1;
    }

    function populateDatalist() {
      datalist.innerHTML = "";
      const names = Object.values(nameMap).sort((a, b) => a.localeCompare(b, "da"));
      for (const n of names) {
        const opt = document.createElement("option");
        opt.value = n;
        datalist.appendChild(opt);
      }
    }

    function persistDatabase() {
      localStorage.setItem("frida_database", JSON.stringify(database));
      localStorage.setItem("frida_nameMap", JSON.stringify(nameMap));
    }

    // ====== Table rendering ======
    function updateTable() {
      tableBody.innerHTML = "";
      let total = 0;

      entries.forEach((item, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border p-2">${item.name}</td>
          <td class="border p-2">${item.grams}</td>
          <td class="border p-2">${item.kulPer100.toFixed(1)}</td>
          <td class="border p-2">${item.totalKul.toFixed(2)}</td>
          <td class="border p-2 w-40">
            <div class="flex justify-end gap-2">
              <button class="bg-yellow-500 hover:bg-yellow-600 text-white p-1 rounded" onclick="editEntry(${index})" title="Rediger">
                <!-- Pencil icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/>
                  <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4a1 1 0 110 2H6v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                </svg>
              </button>
              <button class="bg-red-500 hover:bg-red-600 text-white p-1 rounded" onclick="deleteEntry(${index})" title="Slet">
                <!-- Trash icon (outline) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M3 7h18M8 7V4a1 1 0 011-1h6a1 1 0 011 1v3"/>
                </svg>
              </button>
            </div>
          </td>
        `;
        tableBody.appendChild(tr);
        total += item.totalKul;
      });

      totalCell.textContent = total.toFixed(2);
      clearAllBtn.disabled = entries.length === 0;
    }

    // Expose for inline onclick
    window.editEntry = function(index) {
      const item = entries[index];
      navnInput.value = item.name;
      gramInput.value = item.grams;
      entries.splice(index, 1);
      updateTable();
    };

    window.deleteEntry = function(index) {
      entries.splice(index, 1);
      updateTable();
    };

    // ====== File handling ======
    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      showSpinner(true);
      controls.classList.add("hidden"); // skjul inputs mens vi indlæser

      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          database = {};
          nameMap = {};
          entries = [];
          updateTable();

          const sheetName = "Data_Table";
          if (!workbook.SheetNames.includes(sheetName)) {
            alert(`Sheet "${sheetName}" findes ikke i filen.`);
            return;
          }

          const sheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          if (jsonData.length < 5) {
            alert("Sheet har ikke nok rækker til at læse data korrekt.");
            return;
          }

          const kulIdx  = findColumnIndex(jsonData[0], "tilgængelig kulhydrat");
          const navnIdx = findColumnIndex(jsonData[3], "fødevarenavn");

          if (kulIdx === -1 || navnIdx === -1) {
            alert("Kolonnerne kunne ikke findes korrekt.");
            return;
          }

          for (let i = 4; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (!row) continue;
            const navn = row[navnIdx];
            const kul  = parseFloat(row[kulIdx]);
            if (navn !== undefined && navn !== null && navn !== "" && !Number.isNaN(kul)) {
              const lower = navn.toString().toLowerCase();
              if (database[lower] === undefined) {
                database[lower] = kul;
                nameMap[lower] = navn.toString();
              }
            }
          }

          persistDatabase();
          populateDatalist();
          controls.classList.remove("hidden");
        } catch (err) {
          alert("Fejl under filindlæsning: " + err.message);
        } finally {
          showSpinner(false);
        }
      };

      reader.readAsArrayBuffer(file);
    }

    // ====== Form submit ======
    function onSubmit(e) {
      e.preventDefault();
      const rawName = navnInput.value.trim();
      const key = rawName.toLowerCase();
      const grams = parseFloat(gramInput.value);

      if (database[key] === undefined) {
        alert("Ingrediens ikke fundet i databasen.");
        return;
      }
      if (Number.isNaN(grams) || grams <= 0) {
        alert("Indtast venligst en gyldig mængde i gram.");
        return;
      }

      const kulPer100 = database[key];        // may be 0 — that's fine
      const totalKul  = (kulPer100 * grams) / 100;

      entries.push({
        name: nameMap[key] || rawName,
        grams,
        kulPer100,
        totalKul
      });

      updateTable();
      form.reset();
      navnInput.focus();
    }

    // ====== Clear all ======
    function onClearAll() {
      if (!entries.length) return;
      if (confirm("Er du sikker på, at du vil rydde alle ingredienser?")) {
        entries = [];
        updateTable();
      }
    }

    // ====== Boot (load dataset only; table starts empty) ======
    (function init() {
      // Try load dataset
      const savedDb  = localStorage.getItem("frida_database");
      const savedMap = localStorage.getItem("frida_nameMap");
      if (savedDb && savedMap) {
        try {
          database = JSON.parse(savedDb);
          nameMap  = JSON.parse(savedMap);
          populateDatalist();
          controls.classList.remove("hidden");
        } catch { /* ignore parse errors */ }
      }

      // Always start with an empty table
      entries = [];
      updateTable();

      // Wire events
      fileInput.addEventListener("change", handleFile);
      form.addEventListener("submit", onSubmit);
      clearAllBtn.addEventListener("click", onClearAll);
    })();
  </script>
</body>
</html>
